---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllCategories, searchCables, getMaxDataRate, getMaxPower } from '../utils/cableData';

// Get data for server-side calculations only
const allCategories = getAllCategories();
const totalCableCount = allCategories.reduce((total, cat) => total + cat.cables.length, 0);

// Calculate popular search results dynamically
const popularSearches = [
  'USB-C', 'Thunderbolt', 'HDMI', '40 Gbps', '100W', 'DisplayPort'
].map(term => ({
  term,
  count: searchCables(term).length
})).filter(item => item.count > 0);

// Prepare minimal client-side data for search
const clientCables = allCategories.flatMap(cat =>
  cat.cables.map(cable => {
    const primaryProtocol = Object.keys(cable.protocols)[0];
    const primaryProtoInfo = cable.protocols[primaryProtocol];

    return {
      // Search fields
      type: cable.type,
      full_name: cable.full_name,
      common_names: cable.common_names,
      common_devices: cable.common_devices,
      protocol_names: Object.keys(cable.protocols),
      features: Object.values(cable.protocols).flatMap(p => p.features),
      data_rates: Object.values(cable.protocols).map(p => p.data_rate_mbps),

      // Display fields (minimal)
      categorySlug: cat.slug,
      standard_body: cable.standard_body,
      max_rate_mbps: getMaxDataRate(cable),
      max_power: getMaxPower(cable),
      pins: cable.connector.pins,
      reversible: cable.connector.reversible,
      confusion_points: cable.confusion_points,
      notes: cable.notes
    };
  })
);

const title = 'Search Cables | WhatCable';
const description = 'Search the comprehensive cable and connector database by type, protocol, data rate, or power delivery.';
---

<BaseLayout title={title} description={description}>
  <div class="bg-background">
    <div class="max-w-5xl mx-auto px-4 py-8">
      <!-- Header Section -->
      <div class="mb-12">
        <nav class="mb-6 flex" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-2 text-sm">
            <li class="inline-flex items-center">
              <a href="/" class="hover:text-foreground transition-colors">Home</a>
            </li>
            <li>
              <div class="flex items-center">
                <span class="mx-2">/</span>
                <span class="text-foreground font-medium">Search</span>
              </div>
            </li>
          </ol>
        </nav>

        <div class="text-center">
          <h1 class="text-4xl font-bold text-foreground mb-4">Search Cables</h1>

          <!-- Search Form -->
          <div class="max-w-2xl mx-auto mb-8">
            <form method="GET" action="/search" class="flex gap-4" role="search" aria-label="Search cables">
              <input
                type="search"
                name="q"
                placeholder="Search by type, protocol, or data rate (e.g. USB-C, Thunderbolt 4, 40 Gbps)..."
                aria-label="Search cable database by type, protocol, or data rate"
                class="flex-1 px-4 py-3 text-foreground bg-card border border-border rounded-xl shadow-sm focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none"
              />
              <button
                type="submit"
                aria-label="Search cables"
                class="btn btn-primary"
              >
                Search
              </button>
            </form>
          </div>

          <div id="search-status" class="inline-flex items-center px-4 py-2 bg-primary/10 rounded-lg" style="display: none;">
            <span class="font-medium" id="search-status-text"></span>
          </div>

          <div id="search-loading" class="inline-flex items-center px-4 py-2 bg-secondary rounded-lg" style="display: none;">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="font-medium">Searching...</span>
          </div>
        </div>
      </div>

      <!-- Search Results Container -->
      <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="display: none;">
      </div>

      <!-- No Results -->
      <div id="no-results" class="text-center py-12" style="display: none;">
        <div class="mx-auto w-24 h-24 bg-secondary rounded-full flex items-center justify-center mb-6">
          <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-semibold text-foreground mb-2">No results found</h2>
        <p class="mb-6">
          No cables matching "<span class="font-medium" id="no-results-query"></span>".
        </p>
        <div class="space-y-4">
          <p class="text-sm">Try searching for:</p>
          <div class="flex flex-wrap justify-center gap-2">
            {['USB-C', 'HDMI', 'Thunderbolt', 'DisplayPort', '40 Gbps', '100W'].map(suggestion => (
              <a
                href={`/search?q=${encodeURIComponent(suggestion)}`}
                class="filter-chip filter-chip-inactive"
              >
                {suggestion}
              </a>
            ))}
          </div>
        </div>
      </div>

      <!-- Default Content (when no search) -->
      <div id="default-content">
        <div class="text-center py-12">
          <div class="mx-auto w-24 h-24 bg-primary rounded-full flex items-center justify-center mb-6">
            <svg class="w-12 h-12-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <h2 class="text-2xl font-semibold text-foreground mb-4">Search the cable database</h2>
          <p class="mb-8 max-w-2xl mx-auto">
            Find cables by type (USB-C, HDMI), protocol (Thunderbolt 4, USB4), data rate (40 Gbps), or power (100W).
            {totalCableCount > 0 && `The database includes ${totalCableCount} connector types with complete specifications.`}
          </p>

          {popularSearches.length > 0 && (
            <div class="space-y-6">
              <div>
                <h3 class="text-lg font-semibold text-foreground mb-3">Popular Searches</h3>
                <div class="flex flex-wrap justify-center gap-3">
                  {popularSearches.map(item => (
                    <a
                      href={`/search?q=${encodeURIComponent(item.term)}`}
                      class="group rounded-xl border border-border bg-card px-4 py-3 transition-all hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5"
                    >
                      <span class="font-medium text-foreground">{item.term}</span>
                      <span class="block text-sm">{item.count} result{item.count !== 1 ? 's' : ''}</span>
                    </a>
                  ))}
                </div>
              </div>
            </div>
          )}

          <div class="mt-8">
            <h3 class="text-lg font-semibold text-foreground mb-3">Browse by Category</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 max-w-3xl mx-auto">
              <a href="/usb" class="group rounded-xl border border-border bg-card p-4 transition-all hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5">
                <h4 class="font-medium text-foreground">USB</h4>
                <p class="mb-0 text-sm">USB-C, USB-A, Micro</p>
              </a>
              <a href="/video" class="group rounded-xl border border-border bg-card p-4 transition-all hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5">
                <h4 class="font-medium text-foreground">Video</h4>
                <p class="mb-0 text-sm">HDMI, DisplayPort</p>
              </a>
              <a href="/audio" class="group rounded-xl border border-border bg-card p-4 transition-all hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5">
                <h4 class="font-medium text-foreground">Audio</h4>
                <p class="mb-0 text-sm">3.5mm, XLR, RCA</p>
              </a>
              <a href="/power" class="group rounded-xl border border-border bg-card p-4 transition-all hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5">
                <h4 class="font-medium text-foreground">Power</h4>
                <p class="mb-0 text-sm">Barrel, IEC, NEMA</p>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ clientCables }}>
    // Cable data and search functionality
    const cableData = clientCables;

    function formatDataRate(mbps) {
      if (mbps >= 1000) {
        return `${mbps / 1000} Gbps`;
      }
      return `${mbps} Mbps`;
    }

    function searchCables(query) {
      if (!query) return [];

      const searchTerm = query.toLowerCase();

      // Check for data rate pattern (e.g., "40 Gbps", "480 Mbps", "10Gbps")
      const dataRateMatch = query.match(/(\d+\.?\d*)\s*(gbps|mbps|gb\/s|mb\/s)/i);
      let targetRateMbps = null;
      if (dataRateMatch) {
        const value = parseFloat(dataRateMatch[1]);
        const unit = dataRateMatch[2].toLowerCase();
        targetRateMbps = unit.startsWith('g') ? value * 1000 : value;
      }

      // Check for power pattern (e.g., "100W", "240 W")
      const powerMatch = query.match(/(\d+\.?\d*)\s*w/i);
      const targetPower = powerMatch ? parseFloat(powerMatch[1]) : null;

      return cableData.filter(cable => {
        // Standard text matching
        const textMatch = (
          cable.type.toLowerCase().includes(searchTerm) ||
          cable.full_name.toLowerCase().includes(searchTerm) ||
          cable.common_names.some(name => name.toLowerCase().includes(searchTerm)) ||
          cable.common_devices.some(device => device.toLowerCase().includes(searchTerm)) ||
          cable.protocol_names.some(proto => proto.toLowerCase().includes(searchTerm)) ||
          cable.features.some(f => f.toLowerCase().includes(searchTerm))
        );

        // Data rate matching
        const rateMatch = targetRateMbps ? cable.data_rates.some(rate => rate >= targetRateMbps) : false;

        // Power matching
        const powerMatchResult = targetPower ? (cable.max_power && cable.max_power >= targetPower) : false;

        return textMatch || rateMatch || powerMatchResult;
      });
    }

    function highlightSearchTerm(text, searchTerm) {
      if (!searchTerm || !text) return text;
      const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<mark class="bg-warning/30 text-foreground rounded px-0.5">$1</mark>');
    }

    function createCableCard(cable, searchTerm) {
      const confusionWarning = cable.confusion_points.length > 0
        ? `<div class="mb-4 p-3 bg-warning/10 border border-warning/20 rounded-lg">
             <p class="text-warning-foreground text-sm mb-0">${cable.confusion_points[0]}</p>
           </div>`
        : '';

      return `
        <div class="group relative bg-card border border-border rounded-2xl transition-all hover:border-primary/30 hover:shadow-lg hover:shadow-primary/5">
          <a href="/${cable.categorySlug}/${cable.type.toLowerCase().replace(/[^a-z0-9]/g, '-')}" class="block p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-semibold text-foreground mb-1">${highlightSearchTerm(cable.type, searchTerm)}</h3>
                <p class="text-sm mb-0">${highlightSearchTerm(cable.full_name, searchTerm)}</p>
              </div>
              <div class="text-right">
                <span class="badge badge-muted">
                  ${cable.standard_body}
                </span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div>
                <p class="text-xs mb-1">Max Speed</p>
                <p class="text-foreground font-medium mb-0">${formatDataRate(cable.max_rate_mbps)}</p>
              </div>
              ${cable.max_power ? `
              <div>
                <p class="text-xs mb-1">Max Power</p>
                <p class="text-foreground font-medium mb-0">${cable.max_power}W</p>
              </div>
              ` : ''}
            </div>

            <div class="mb-4">
              <p class="text-xs mb-1">Connector</p>
              <p class="text-foreground text-sm mb-0">
                ${cable.pins} pins
                ${cable.reversible ? '<span class="ml-1">(reversible)</span>' : ''}
              </p>
            </div>

            ${confusionWarning}

            <p class="text-sm line-clamp-2 mb-0">${highlightSearchTerm(cable.notes, searchTerm)}</p>
          </a>
        </div>
      `;
    }

    function performSearch() {
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q') || '';
      const searchInput = document.querySelector('input[name="q"]');

      if (searchInput) {
        searchInput.value = query;
      }

      const defaultContent = document.getElementById('default-content');
      const loadingEl = document.getElementById('search-loading');
      const statusEl = document.getElementById('search-status');
      const resultsEl = document.getElementById('search-results');
      const noResultsEl = document.getElementById('no-results');

      if (!query) {
        // Show default content
        statusEl.style.display = 'none';
        loadingEl.style.display = 'none';
        resultsEl.style.display = 'none';
        noResultsEl.style.display = 'none';
        defaultContent.style.display = 'block';
        return;
      }

      // Hide default content
      defaultContent.style.display = 'none';

      // Show loading state
      loadingEl.style.display = 'flex';
      statusEl.style.display = 'none';
      resultsEl.style.display = 'none';
      noResultsEl.style.display = 'none';

      // Simulate brief loading delay for UX
      setTimeout(() => {
        const results = searchCables(query);
        const statusTextEl = document.getElementById('search-status-text');
        const noResultsQueryEl = document.getElementById('no-results-query');

        // Hide loading
        loadingEl.style.display = 'none';

        // Update status
        statusEl.style.display = 'flex';
        statusTextEl.textContent = `${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"`;

        if (results.length > 0) {
          // Show results
          resultsEl.innerHTML = results.map(cable => createCableCard(cable, query)).join('');
          resultsEl.style.display = 'grid';
          noResultsEl.style.display = 'none';
        } else {
          // Show no results
          noResultsQueryEl.textContent = query;
          resultsEl.style.display = 'none';
          noResultsEl.style.display = 'block';
        }
      }, 150); // Brief delay to show loading state
    }

    // Perform search on page load
    document.addEventListener('DOMContentLoaded', performSearch);

    // Handle form submission
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          const query = formData.get('q');
          const url = new URL(window.location);
          url.searchParams.set('q', query);
          window.history.pushState({}, '', url);
          performSearch();
        });
      }
    });
  </script>
</BaseLayout>
